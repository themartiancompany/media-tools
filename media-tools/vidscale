#!/usr/bin/env bash
#
# SPDX-License-Identifier: AGPL-3.0

_bin="$( \
  dirname \
    "$( \
      command \
        -v \
	  "env")")"
_lib="${_bin}/../lib"
_share="${_bin}/../share"
source \
  "${_lib}/libcrash-bash/crash-bash"

_ffmpeg_options_load() {
  local \
    ffmpeg_options
  ffmpeg_options="${_share}/media-tools/ffmpeg_options"
  [ -e "${ffmpeg_options}" ] && \
    source \
      "${ffmpeg_options}" || \
  true
}

_vidscale() {
  local \
    _in="${1}" \
    _out="${2}" \
    _scale="${3}" \
    _scale_opts=() \
    _opts=()
  source \
    "${HOME}/.config/media-tools/ffmpeg_options"
  _scale_opts=(
    "scale=iw*${_scale}"
    "ih*${_scale}"
    "flags=neighbor"
  )
  _opts=(
    "${_ffmpeg_opts[@]}"
    -i "${_in}"
    -vf "$(IFS=":"; \
           echo \
	     "${_scale_opts[*]}")"
    -c:v
      libx265
    -preset
      fast
    -crf
      18
  )
  ffmpeg \
    ${_opts[@]} \
    "${_out}"
}

_globals
(( $# < 3 )) && \
  echo \
    "Usage: vidscale <in> <out> <scale>" && \
  exit

_in="${1}"
_out="${2}"
_scale="${3}"

_ffmpeg_options_load
_config_user_init \
  "media-tools"
_vidscale \
  "${_in}" \
  "${_out}" \
  "${_scale}"
