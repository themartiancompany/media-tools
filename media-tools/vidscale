#!/usr/bin/env bash
#
# SPDX-License-Identifier: AGPL-3.0

_bin="$( \
  dirname \
    "$( \
      command \
        -v \
	  "env")")"
_lib="${_bin}/../lib"
_share="${_bin}/../share"
source \
  "${_lib}/libcrash-bash/crash-bash"

source \
  "${_share}/media-tools/ffmpeg_options"

_config_user_init() {
  local \
    _cfg_dir
  _cfg_dir="${HOME}/.config/$(_get "app" "name")"
  [ ! -e "${_config_user}" ] && \
    cp \
      "${_share}/media-tools/configs/ffmpeg_options" \
      "${_cfg_dir}" || \
    true
}

_vidscale() {
  local \
    _in="${1}" \
    _out="${2}" \
    _scale="${3}" \
    _scale_opts=() \
    _opts=()
  _scale_opts=(
    "scale=iw*${_scale}"
    "ih*${_scale}"
    "flags=neighbor"
  )
  _opts=(
    "${_ffmpeg_opts[@]}"
    -i "${_in}"
    -vf "$(IFS=":"; \
           echo \
	     "${_scale_opts[*]}")"
    -c:v
      libx264
    -preset
      slow
    -crf
      18
  )
  ffmpeg \
    ${_opts[@]} \
    "${_out}"
}

(( $# < 3 )) && \
  echo \
    "Usage: vidscale <in> <out> <scale>" && \
  exit

_in="${1}"
_out="${2}"
_scale="${3}"

_vidscale \
  "${_in}" \
  "${_out}" \
  "${_scale}"
